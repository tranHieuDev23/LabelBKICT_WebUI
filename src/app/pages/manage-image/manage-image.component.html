<div nz-row>
    <div nz-col class="region-selector-col" [nzSpan]="24" [nzMd]="16" [nzXl]="18">
        <app-region-selector #regionSelector *ngIf="image" [imageSrc]="image.originalImageURL" [regionList]="regionList"
            (regionSelected)="onRegionSelected($event)" (regionEdited)="onRegionEdited($event)"
            (regionDbClicked)="onRegionDbClicked($event)" (contextMenu)="onContextMenu($event)">
        </app-region-selector>
    </div>
    <div nz-col class="sidebar-col" [nzSpan]="24" [nzMd]="8" [nzXl]="6">
        <nz-skeleton *ngIf="!image"></nz-skeleton>
        <div *ngIf="image">
            <h1 nz-typography>Manage image</h1>

            <p>
                <nz-tag nzColor="magenta">
                    {{ image.imageType?.displayName || 'No type' }}
                </nz-tag>
                <nz-tag [nzColor]="getImageStatusColor(image.status)">
                    {{ getImageStatusString(image.status) }}
                </nz-tag>
            </p>

            <p>
                <app-editable-tag-list [allImageTagGroupList]="allowedImageTagGroupListForImageType"
                    [allImageTagList]="allowedImageTagListForImageType" [editable]="true" [imageTagList]="imageTagList"
                    (imageTagAdded)="onImageTagForUploadedImageAdded($event)"
                    (imageTagDeleted)="onImageTagForUploadedImageDeleted($event)">
                </app-editable-tag-list>
            </p>

            <p>Original file name: <b>{{ image.originalFileName }}</b></p>

            <p>
                Uploaded on {{ image.uploadTime | date:'short' }} by
                <b>{{ image.uploadedByUser.displayName }}</b>
            </p>

            <p *ngIf="image.publishedByUser" nz-typography>
                Published on {{ image.publishTime | date:'short' }} by
                <b>{{ image.publishedByUser.displayName }}</b>
            </p>

            <p *ngIf="image.verifiedByUser" nz-typography>
                Published on {{ image.verifyTime | date:'short' }} by
                <b>{{ image.verifiedByUser.displayName }}</b>
            </p>

            <nz-collapse nzAccordion>
                <nz-collapse-panel nzHeader="Description" nzActive="true">
                    <app-editable-text #descriptionEditableText [text]="image.description" [editable]="editable"
                        [placeholder]="editable? 'Add image description...' : 'No description'" [multiline]="true"
                        (textEdited)="onImageDescriptionUpdated($event)">
                    </app-editable-text>
                </nz-collapse-panel>

                <nz-collapse-panel nzHeader="Shortcuts">
                    <ul>
                        <li *ngIf="editable">Ctrl + Z/Ctrl + Shift + Z: Undo/Redo</li>
                        <li *ngIf="editable">Ctrl + Enter: Finish drawing</li>
                        <li *ngIf="editable">Escape: Clear selection</li>
                        <li>Ctrl + Middle mouse scroll: Zoom</li>
                        <li>Ctrl + Left mouse drag: Move image</li>
                        <li>Ctrl + Shift + P: Publish image</li>
                        <li>Left/right arrow: Next/previous image</li>
                        <li>Right click: Menu</li>
                    </ul>
                </nz-collapse-panel>
            </nz-collapse>

            <div *ngIf="editable" class="action-buttons">
                <button *ngIf="!isImageExcluded() && !isImagePublished()" nz-button nzType="primary"
                    (click)="onExcludeImageClicked()">
                    <i nz-icon nzType="minus-circle"></i> Exclude from labeling
                </button>
                <button *ngIf="isImageExcluded()" nz-button nzType="primary" (click)="onIncludeImageClicked()">
                    <i nz-icon nzType="plus-circle"></i> Include for labeling
                </button>
                <button *ngIf="!isImageExcluded()" nz-button nzType="primary" [disabled]="!isImagePublishable()"
                    (click)="onPublishImageClicked()">
                    <i nz-icon nzType="check-circle"></i> Publish
                </button>
                <button nz-button (click)="onImageSettingsClicked()">
                    <i nz-icon nzType="setting"></i> Settings
                </button>
            </div>
        </div>
    </div>
</div>

<nz-modal *ngIf="isLabelRegionModalVisible" nzTitle="Label region" [nzVisible]="isLabelRegionModalVisible"
    [nzClosable]="false" nzCancelText="Close" (nzOnCancel)="onCloseLabelRegionModal()" [nzOkText]="null">
    <div *nzModalContent>
        <nz-list nzBordered>
            <nz-list-item *ngFor="let regionLabel of regionLabelList" class="label-region-modal-item"
                (click)="onLabelRegionModalItemClicked(regionLabel)">
                <span nz-typography>{{ regionLabel.displayName }}</span>
            </nz-list-item>
        </nz-list>
    </div>
</nz-modal>

<nz-modal *ngIf="isRegionInformationModalVisible" nzTitle="Region information"
    [nzVisible]="isRegionInformationModalVisible" [nzClosable]="false" nzCancelText="Close"
    (nzOnCancel)="onRegionInformationModalClose()" [nzOkText]="null">
    <div *nzModalContent>
        <img class="modal-image" [src]="regionInformationModalImage" />
        <p *ngIf="regionInformationModalRegion?.label" nz-typography>
            Labeled by <b>{{ regionInformationModalRegion?.labeledByUser?.displayName }}</b> as <b>{{
                regionInformationModalRegion?.label?.displayName }}</b>
        </p>
        <p *ngIf="!(regionInformationModalRegion?.label)" nz-typography>
            Not yet labeled
        </p>
        <button *ngIf="editable" nz-button nzDanger nzType="primary"
            (click)="onRegionInformationModalDeleteRegionClicked()" style="margin-top: 8px">
            <i nz-icon nzType="delete"></i> Delete region
        </button>
    </div>
</nz-modal>

<nz-modal *ngIf="isImageSettingsModalVisible" nzTitle="Image Settings" [nzVisible]="isImageSettingsModalVisible"
    [nzClosable]="false" nzCancelText="Close" (nzOnCancel)="onImageSettingsModalClose()" [nzOkText]="null">
    <div *nzModalContent>
        <h4 nz-typography>Change image type</h4>
        <p nz-typography>
            This will remove all tags from this image, and mark all regions extracted from it as not labeled.
        </p>
        <div>
            Image type <nz-select class="image-type-select" nzPlaceHolder="Select image type"
                [(ngModel)]="imageSettingsModalSelectedImageType"
                (ngModelChange)="onImageSettingsModalCloseImageTypeClicked($event)">
                <nz-option *ngFor="let imageType of imageSettingsModalImageTypeList" [nzValue]="imageType"
                    [nzLabel]="imageType.displayName"
                    [nzDisabled]="image?.imageType && imageType.id === image?.imageType?.id">
                </nz-option>
            </nz-select>
        </div>
        <h4 nz-typography style="margin-top: 8px;">Delete this image</h4>
        <p nz-typography>
            This will also delete all regions extracted from it.
        </p>
        <button nz-button nzType="primary" nzDanger
            (click)="onImageSettingsModalCloseImageTypeClickedDeleteImageClicked()">
            <i nz-icon nzType="delete"></i> Delete
        </button>
    </div>
</nz-modal>

<nz-dropdown-menu #contextMenu>
    <ul nz-menu oncontextmenu="() => false;">
        <li nz-menu-item (click)="onContextMenuResetZoomClicked()">Reset zoom</li>
        <li *ngIf="isRegionListVisible()" nz-menu-item (click)="onContextMenuHideRegionsClicked()">
            Hide regions
        </li>
        <li *ngIf="!isRegionListVisible()" nz-menu-item (click)="onContextMenuShowRegionsClicked()">
            Show regions
        </li>
        <li *ngIf="isRegionSelectorIsInDrawState()" nz-menu-item (click)="regionSelector?.finishDrawing()">
            Finish drawing region
        </li>
        <li *ngIf="contextMenuRegion && editable" nz-menu-item (click)="onContextMenuEditRegionBoundaryClicked()">
            Edit region boundary
        </li>
        <li *ngIf="isRegionSelectorIsInSelectedState()" nz-submenu nzTitle="Add region as...">
            <ul>
                <li *ngFor="let regionLabel of regionLabelList" nz-menu-item (click)="addSelectedRegion(regionLabel)">
                    {{ regionLabel.displayName }}
                </li>
            </ul>
        </li>
        <li *ngIf="contextMenuRegion && editable" nz-submenu nzTitle="Relabel region as...">
            <ul>
                <li *ngFor="let regionLabel of regionLabelList" nz-menu-item
                    [nzDisabled]="regionLabel.id === contextMenuRegion.label?.id"
                    (click)="onContextMenuRelabelRegionLabelClicked(regionLabel)">
                    {{ regionLabel.displayName }}
                </li>
            </ul>
        </li>
        <li *ngIf="isRegionSelectorIsInSelectedState()" nz-menu-item (click)="regionSelector?.cancelDrawing()">
            Clear selection
        </li>
        <li *ngIf="contextMenuRegion" nz-menu-item (click)="onContextMenuShowRegionInfoClicked()">
            Show region info
        </li>
        <li *ngIf="contextMenuRegion && editable" nz-menu-item nzDanger (click)="onContextMenuDeleteRegionClicked()">
            Delete region
        </li>
        <!-- <li *ngIf="editable" nz-menu-item nzDanger (click)="onDeleteAllRegionsClicked()">
            Delete all regions
        </li> -->
    </ul>
</nz-dropdown-menu>